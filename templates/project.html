{% extends "base.html" %}

{% block title %}Project Analytics | AeroCore Drone Intelligence{% endblock %}

{% block breadcrumb %}
<i class="fa-solid fa-microchip"></i> Sector Alpha: <span class="text-primary">Deep Survey Analysis</span>
{% endblock %}

{% block extra_css %}
<style>
  .project-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 1.5rem;
  }

  .analysis-header {
    grid-column: span 12;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .telemetry-grid {
    grid-column: span 12;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .main-view {
    grid-column: span 8;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .side-controls {
    grid-column: span 4;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  @media (max-width: 1200px) {

    .main-view,
    .side-controls {
      grid-column: span 12;
    }
  }

  .media-placeholder {
    width: 100%;
    aspect-ratio: 16/9;
    background: var(--bg-glass);
    border: 1px dashed var(--border);
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-dim);
    gap: 1rem;
  }

  .media-placeholder i {
    font-size: 3rem;
    color: var(--primary);
    opacity: 0.3;
  }

  .tab-nav {
    display: flex;
    gap: 0.5rem;
    background: var(--bg-glass);
    padding: 0.4rem;
    border-radius: var(--radius-sm);
    margin-bottom: 1.5rem;
    border: 1px solid var(--border);
  }

  .tab-trigger {
    flex: 1;
    padding: 0.6rem;
    border: none;
    background: transparent;
    color: var(--text-dim);
    font-family: 'Space Grotesk';
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    border-radius: 4px;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .tab-trigger.active {
    background: var(--primary);
    color: var(--bg-darker);
    box-shadow: 0 0 15px var(--primary-glow);
  }

  .tab-panel {
    display: none;
  }

  .tab-panel.active {
    display: block;
    animation: fadeIn 0.4s ease;
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.75rem;
  }

  .gallery-item {
    aspect-ratio: 1;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg-glass);
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition);
  }

  .gallery-item:hover {
    border-color: var(--primary);
    transform: scale(1.05);
    box-shadow: 0 0 15px var(--primary-glow);
  }

  .volume-metric {
    background: linear-gradient(135deg, rgba(0, 242, 255, 0.05), rgba(125, 95, 255, 0.05));
    border: 1px solid var(--border-glow);
    padding: 1.5rem;
    border-radius: var(--radius-md);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
</style>
{% endblock %}

{% block content %}
<div class="project-grid">
  <div class="analysis-header">
    <div style="margin-bottom: 2.5rem;">
      <p class="subtitle">System Analytics</p>
      <h1 style="font-size: 2.25rem; margin-bottom: 0.5rem; letter-spacing: -0.5px;">PROJECT DETAILS</h1>
    </div>
    <p style="color: var(--text-muted); font-size: 0.8125rem;">Advanced volume estimation and photogrammetry data</p>
    <div style="display: flex; gap: 1rem;">
      <div style="text-align: right;">
        <p style="font-size: 0.625rem; color: var(--text-dim); text-transform: uppercase; margin-bottom: -0.25rem;">
          Satellite Uplink</p>
        <p style="font-size: 0.875rem; font-weight: 700; color: var(--success);"><i class="fa-solid fa-signal"></i>
          SECURE_LINK_7</p>
      </div>
    </div>
  </div>

  <!-- Quick Telemetry -->
  <div class="telemetry-grid">
    <div class="glass-panel" style="padding: 1.5rem; text-align: center;">
      <p style="font-size: 2rem; font-weight: 700; color: var(--primary); margin: 0;" id="stat-images">--</p>
      <p style="font-size: 0.625rem; color: var(--text-dim); text-transform: uppercase;">Drone Frames</p>
    </div>
    <div class="glass-panel" style="padding: 1.5rem; text-align: center;">
      <p style="font-size: 2rem; font-weight: 700; color: var(--secondary); margin: 0;" id="stat-videos">--</p>
      <p style="font-size: 0.625rem; color: var(--text-dim); text-transform: uppercase;">Video Buffers</p>
    </div>
    <div class="glass-panel" style="padding: 1.5rem; text-align: center;">
      <p style="font-size: 2rem; font-weight: 700; color: var(--accent); margin: 0;" id="stat-requests">--</p>
      <p style="font-size: 0.625rem; color: var(--text-dim); text-transform: uppercase;">Mission Log</p>
    </div>
    <div class="glass-panel" style="padding: 1.5rem; text-align: center;">
      <p style="font-size: 1.5rem; font-weight: 700; color: var(--success); margin: 0.25rem 0;" id="stat-storage">--</p>
      <p style="font-size: 0.625rem; color: var(--text-dim); text-transform: uppercase;">Cloud Density</p>
    </div>
  </div>

  <!-- Main View: Video & Media -->
  <div class="main-view">
    <div class="glass-panel" style="padding: 1.5rem;">
      <div class="module-header">
        <i class="fa-solid fa-satellite"></i>
        <h3 style="margin: 0;">LIVE SENSOR FEED</h3>
      </div>
      <div
        style="position: relative; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--border); background: #000; aspect-ratio: 16/9;">
        <img src="/video" style="width: 100%; height: 100%; object-fit: cover;" alt="Awaiting Feed...">
        <div
          style="position: absolute; bottom: 1rem; left: 1rem; background: rgba(0,0,0,0.6); padding: 0.4rem 0.8rem; border-radius: var(--radius-sm); font-family: monospace; font-size: 0.75rem; color: var(--primary); border: 1px solid var(--border);">
          <i class="fa-solid fa-calendar-days"></i> <span id="streamDate">--/--/--</span> | <i
            class="fa-solid fa-clock"></i> <span id="streamTime">--:--:--</span>
        </div>
      </div>
    </div>

    <div class="glass-panel" style="padding: 1.5rem;">
      <div class="module-header">
        <i class="fa-solid fa-cube-unfolded"></i>
        <h3 style="margin: 0;">SPATIAL DATA ENGINE</h3>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <!-- 3D Viewer -->
        <div>
          <p
            style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 1px;">
            3D Photogrammetry</p>
          <div id="mappingViewer" class="media-placeholder">
            <i class="fa-solid fa-cube"></i>
            <p style="font-size: 0.75rem;">Initialize scan to view data</p>
          </div>
        </div>
        <!-- Photo Gallery -->
        <div>
          <p
            style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 1px;">
            Geotagged Frames</p>
          <div id="photoGallery" class="media-placeholder" style="display: block; padding: 1rem; overflow-y: auto;">
            <div style="text-align: center; margin-top: 2rem;">
              <i class="fa-solid fa-images"></i>
              <p style="font-size: 0.75rem; margin-top: 1rem;">No telemetry frames available</p>
            </div>
          </div>
        </div>
      </div>

      <div id="volumeResult" class="volume-metric animate-fade-in" style="display: none;">
        <!-- Volume data injected here -->
      </div>
    </div>
  </div>

  <!-- Side Controls: Mission Comms -->
  <div class="side-controls">
    <div class="glass-panel" style="padding: 1.5rem;">
      <div class="tab-nav">
        <button class="tab-trigger active" onclick="switchTab('request')"><i class="fa-solid fa-paper-plane"></i>
          SURVEY</button>
        <button class="tab-trigger" onclick="switchTab('chat')"><i class="fa-solid fa-brain-circuit"></i>
          INTELLIGENCE</button>
      </div>

      <!-- Survey Request Panel -->
      <div id="request-tab" class="tab-panel active">
        <div class="form-group">
          <label class="form-label">Mission Objectives</label>
          <textarea id="message" rows="4" class="form-input"
            placeholder="Enter coordinates or site description..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Operator Primary Email</label>
          <input type="email" id="email" class="form-input" placeholder="operator@aerocore.systems">
        </div>
        <div class="form-group">
          <label class="form-label">Comms Link (WhatsApp)</label>
          <input type="text" id="phone" class="form-input" placeholder="+91 00000 00000">
        </div>
        <button onclick="sendRequest()" class="btn-aero btn-primary" id="submitBtn"
          style="width: 100%; justify-content: center;">
          TRANSMIT REQUEST <i class="fa-solid fa-satellite-dish" style="margin-left: 0.5rem;"></i>
        </button>
        <a href="{{ url_for('download_report') }}" class="btn-aero btn-outline"
          style="width: 100%; justify-content: center; margin-top: 1rem; text-decoration: none;">
          <i class="fa-solid fa-file-pdf"></i> ARCHIVE MISSION REPORT
        </a>
        <div id="result" style="margin-top: 1rem;"></div>
      </div>

      <!-- AI Chat Panel -->
      <div id="chat-tab" class="tab-panel">
        <div class="chat-terminal" id="aiResult" style="height: 250px; margin-bottom: 1.5rem;">
          <p style="color: var(--text-muted); font-size: 0.75rem; text-align: center; margin-top: 4rem;">
            INTELLIGENCE_INIT_COMPLETE... Awaiting Input</p>
        </div>
        <div class="form-group">
          <label class="form-label">Query Core</label>
          <textarea id="chatMessage" rows="3" class="form-input"
            placeholder="Query volume, site status, or mapping depth..."></textarea>
        </div>
        <button onclick="sendAIChat()" class="btn-aero btn-primary" id="chatBtn"
          style="width: 100%; justify-content: center;">
          EXECUTE QUERY <i class="fa-solid fa-terminal" style="margin-left: 0.5rem;"></i>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // System Time Sync
  function updateClock() {
    const now = new Date();
    document.getElementById("streamDate").textContent = now.toLocaleDateString('en-GB');
    document.getElementById("streamTime").textContent = now.toLocaleTimeString('en-GB');
  }
  setInterval(updateClock, 1000);
  updateClock();

  // Stats Engine
  function loadStats() {
    fetch("/api/statistics")
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          const s = data.data;
          document.getElementById("stat-images").textContent = s.images;
          document.getElementById("stat-videos").textContent = s.videos;
          document.getElementById("stat-requests").textContent = s.requests;
          document.getElementById("stat-storage").textContent = s.storage_mb > 1024 ? (s.storage_mb / 1024).toFixed(1) + " GB" : s.storage_mb.toFixed(0) + " MB";
        }
      });
  }
  loadStats();
  setInterval(loadStats, 5000);

  // Tab Interface
  function switchTab(tab) {
    document.getElementById("request-tab").classList.remove("active");
    document.getElementById("chat-tab").classList.remove("active");
    document.querySelectorAll(".tab-trigger").forEach(btn => btn.classList.remove("active"));

    document.getElementById(tab + "-tab").classList.add("active");
    event.target.closest(".tab-trigger").classList.add("active");
  }

  // Communication Handlers
  function sendRequest() {
    const payload = {
      message: document.getElementById("message").value,
      email: document.getElementById("email").value,
      phone: document.getElementById("phone").value
    };

    const btn = document.getElementById("submitBtn");
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-sync fa-spin"></i> TRANSMITTING...';

    fetch("/ai_request", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
      .then(res => res.json())
      .then(data => {
        btn.disabled = false;
        btn.innerHTML = 'TRANSMIT REQUEST <i class="fa-solid fa-satellite-dish" style="margin-left: 0.5rem;"></i>';
        const resDiv = document.getElementById("result");
        if (data.status === "success") {
          resDiv.innerHTML = `<div class="glass-panel" style="padding: 1rem; border-left: 3px solid var(--success); font-size: 0.75rem;"><i class="fa-solid fa-check text-success"></i> UPLINK_SUCCESS: Record ${data.file} logged.</div>`;
        } else {
          resDiv.innerHTML = `<div class="glass-panel" style="padding: 1rem; border-left: 3px solid var(--danger); font-size: 0.75rem;"><i class="fa-solid fa-xmark text-danger"></i> UPLINK_ERROR: ${data.message}</div>`;
        }
      });
  }

  function sendAIChat() {
    const msg = document.getElementById("chatMessage").value;
    if (!msg.trim()) return;

    const btn = document.getElementById("chatBtn");
    const box = document.getElementById("aiResult");

    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-microchip fa-spin"></i> PROCESSING...';

    fetch("/chat_ai", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: msg })
    })
      .then(res => res.json())
      .then(data => {
        btn.disabled = false;
        btn.innerHTML = 'EXECUTE QUERY <i class="fa-solid fa-terminal" style="margin-left: 0.5rem;"></i>';

        box.innerHTML = `
                <div class="terminal-msg msg-ai" style="margin:0; width:100%; font-size:0.75rem;">
                    <span style="color:var(--primary); font-weight:700;">[INTEL_REPLY]</span><br>
                    ${data.reply.replace(/\n/g, "<br>")}
                </div>
            `;

        if (data.volume) {
          updateMappingUI(data.volume, data.map_image, data.geo_image);
        }
      });
  }

  function updateMappingUI(volume, mapImg, geoImg) {
    document.getElementById("volumeResult").style.display = "flex";
    document.getElementById("volumeResult").innerHTML = `
            <div>
                <p style="font-size: 0.625rem; color: var(--text-dim); text-transform: uppercase;">Estimated Site Volume</p>
                <p style="font-size: 1.5rem; font-weight: 700; color: var(--success); margin: 0;">${volume} <span style="font-size: 0.875rem;">mÂ³</span></p>
            </div>
            <div style="text-align: right;">
                <p style="font-size: 0.625rem; color: var(--text-dim); text-transform: uppercase;">Confidence Interval</p>
                <p style="font-size: 0.875rem; font-weight: 600; color: var(--primary); margin: 0;">94.2% [ODM_STABLE]</p>
            </div>
        `;

    if (mapImg) {
      document.getElementById("mappingViewer").innerHTML = `<img src="${mapImg}?t=${Date.now()}" style="width:100%; height:100%; object-fit:cover; border-radius:var(--radius-sm);">`;
    }
    if (geoImg) {
      document.getElementById("photoGallery").innerHTML = `
                <div class="gallery-grid">
                    <div class="gallery-item"><img src="${geoImg}?t=${Date.now()}" style="width:100%; height:100%; object-fit:cover;"></div>
                </div>
            `;
    }
  }
</script>
{% endblock %}